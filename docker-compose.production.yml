# docker-compose.production.yml
version: '3.8'

services:
  # ============================================
  # 1. APPLICATION LARAVEL (API Server)
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: leyinvest_app
    restart: unless-stopped
    working_dir: /var/www/html
    # ... (Variables d'environnement DB/Redis HOST, gérées par Dokploy)
    networks:
      - leyinvest-network
      - dokploy-network  # Connexion au réseau Traefik
    deploy:
      mode: replicated
      replicas: 2 # Au moins 2 pour la haute disponibilité
      update_config:
        order: start-first
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      # --- API ROUTING ---
      - "traefik.enable=true"
      - "traefik.http.routers.leyinvest-https.rule=Host(`${APP_DOMAIN:-api.leyinvest.com}`)"
      - "traefik.http.routers.leyinvest-https.entrypoints=websecure"
      # ... (Autres labels de sécurité et middlewares comme dans ton exemple initial)
      - "traefik.http.services.leyinvest.loadbalancer.server.port=80"

  # ============================================
  # 2. HORIZON/QUEUE WORKER (Traitement Asynchrone)
  # ============================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: leyinvest_worker
    restart: always
    working_dir: /var/www/html
    # COMMANDE : Lancer Horizon pour gérer les workers
    command: php /var/www/html/artisan horizon
    networks:
      - leyinvest-network
      # NE PAS UTILISER DOKPLOY-NETWORK, CAR AUCUN ACCÈS EXTERNE
    environment:
      # ... (Variables d'environnement, incluant REDIS_HOST)
    deploy:
      mode: replicated
      replicas: 3 # Scalable selon la charge
    labels:
      - "traefik.enable=false" # Accès interne seulement

  # ============================================
  # 3. SCHEDULER (Tâches Cron)
  # ============================================
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: leyinvest_scheduler
    restart: always
    working_dir: /var/www/html
    # COMMANDE CRUCIALE : Exécution du cron en boucle
    command: sh -c "while true; do php artisan schedule:run; sleep 60; done"
    networks:
      - leyinvest-network
    environment:
      # ... (Variables d'environnement)
    deploy:
      mode: replicated
      replicas: 1 # OBLIGATOIREMENT 1 pour garantir l'exécution unique
    labels:
      - "traefik.enable=false" # Accès interne seulement

  # ============================================
  # 4. LARAVEL HORIZON UI (Interface de Monitoring)
  # Requis pour la surveillance FinTech, utilise le même build que l'app.
  # ============================================
  horizon-ui:
    build:
      context: .
      dockerfile: Dockerfile.production
    container_name: leyinvest_horizon_ui
    restart: unless-stopped
    working_dir: /var/www/html
    # COMMANDE : Lancer le serveur web simple pour l'interface Horizon
    command: php -S 0.0.0.0:80 artisan horizon:serve
    networks:
      - dokploy-network # Doit être sur le réseau Traefik pour l'exposition
    environment:
      # ... (Variables d'environnement)
    labels:
      # --- HORIZON UI ROUTING ---
      - "traefik.enable=true"
      - "traefik.http.routers.horizon-https.rule=Host(`horizon.leyinvest.com`)"
      - "traefik.http.routers.horizon-https.entrypoints=websecure"
      - "traefik.http.routers.horizon-https.tls=true"
      - "traefik.http.routers.horizon-https.tls.certresolver=letsencrypt"

      # SECURITY (CRITICAL) : Ajouter un Basic Auth pour protéger l'interface
      - "traefik.http.routers.horizon-https.middlewares=horizon-auth@docker"
      - "traefik.http.middlewares.horizon-auth.basicauth.users=admin:$$apr1$$XXXXXXXXXX$$YYYYYYYYYY" # REMPLACER PAR UN HASH SÉCURISÉ

      - "traefik.http.services.horizon-ui.loadbalancer.server.port=80"

# ... (Networks et Volumes, en externe pour Dokploy)
networks:
  leyinvest-network:
    driver: bridge
  dokploy-network:
    external: true
