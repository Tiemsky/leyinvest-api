name: Beta Deployment

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: laravel_test
          POSTGRES_USER: laravel
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, dom, fileinfo, pgsql, redis
          coverage: xdebug

      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.testing', '.env');"

      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Generate key
        run: php artisan key:generate

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Run Tests
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: laravel_test
          DB_USERNAME: laravel
          DB_PASSWORD: secret
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: php artisan test --coverage

      - name: Run Static Analysis (PHPStan)
        run: |
          composer require --dev phpstan/phpstan
          vendor/bin/phpstan analyse --memory-limit=2G || true

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=beta-
            type=raw,value=beta-latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            APP_ENV=staging

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.BETA_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.BETA_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup on remote server
        run: |
          ssh ${{ secrets.BETA_USER }}@${{ secrets.BETA_HOST }} << 'EOF'
            set -e

            BACKUP_DIR="/var/backups/laravel/beta"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            APP_DIR="/var/www/beta"

            # Create backup directory
            mkdir -p $BACKUP_DIR

            # Database backup
            echo "üóÑÔ∏è  Backing up database..."
            docker exec beta_postgres pg_dump -U ${{ secrets.BETA_DB_USER }} ${{ secrets.BETA_DB_NAME }} | gzip > $BACKUP_DIR/db_${TIMESTAMP}.sql.gz

            # Storage backup
            echo "üìÅ Backing up storage..."
            tar -czf $BACKUP_DIR/storage_${TIMESTAMP}.tar.gz -C $APP_DIR storage/app

            # Keep only last 7 backups
            echo "üßπ Cleaning old backups..."
            ls -t $BACKUP_DIR/db_*.sql.gz | tail -n +8 | xargs -r rm
            ls -t $BACKUP_DIR/storage_*.tar.gz | tail -n +8 | xargs -r rm

            echo "‚úÖ Backup completed: ${TIMESTAMP}"
          EOF

      - name: Deploy to Beta Server
        run: |
          ssh ${{ secrets.BETA_USER }}@${{ secrets.BETA_HOST }} << 'EOF'
            set -e

            cd /var/www/beta

            # Login to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest image
            echo "üì¶ Pulling latest image..."
            docker-compose -f docker-compose.beta.yml pull

            # Stop application gracefully
            echo "‚è∏Ô∏è  Stopping application..."
            docker-compose -f docker-compose.beta.yml down

            # Start services
            echo "üöÄ Starting services..."
            docker-compose -f docker-compose.beta.yml up -d

            # Wait for services to be healthy
            echo "‚è≥ Waiting for services..."
            sleep 10

            # Run migrations
            echo "üîÑ Running migrations..."
            docker-compose -f docker-compose.beta.yml exec -T app php artisan migrate --force

            # Clear and cache config
            echo "üîß Optimizing application..."
            docker-compose -f docker-compose.beta.yml exec -T app php artisan config:cache
            docker-compose -f docker-compose.beta.yml exec -T app php artisan route:cache
            docker-compose -f docker-compose.beta.yml exec -T app php artisan view:cache

            # Restart queue workers
            echo "üîÑ Restarting queue workers..."
            docker-compose -f docker-compose.beta.yml exec -T app php artisan queue:restart

            echo "‚úÖ Deployment completed successfully!"
          EOF

      - name: Health Check
        run: |
          echo "üè• Running health check..."
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.BETA_DOMAIN }}/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ùå Health check failed with status: $response"
            exit 1
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Beta deployment successful!"
          else
            echo "‚ùå Beta deployment failed!"
          fi
          # Add Slack/Discord webhook notification here if needed

  rollback:
    runs-on: ubuntu-latest
    if: failure()
    needs: [deploy]

    steps:
      - name: Rollback deployment
        run: |
          ssh ${{ secrets.BETA_USER }}@${{ secrets.BETA_HOST }} << 'EOF'
            set -e

            cd /var/www/beta

            # Find latest backup
            LATEST_DB=$(ls -t /var/backups/laravel/beta/db_*.sql.gz | head -n1)
            LATEST_STORAGE=$(ls -t /var/backups/laravel/beta/storage_*.tar.gz | head -n1)

            echo "üîô Rolling back to previous version..."

            # Restore database
            gunzip < $LATEST_DB | docker exec -i beta_postgres psql -U ${{ secrets.BETA_DB_USER }} ${{ secrets.BETA_DB_NAME }}

            # Restore storage
            tar -xzf $LATEST_STORAGE -C /var/www/beta

            # Use previous image version
            docker-compose -f docker-compose.beta.yml up -d --force-recreate

            echo "‚úÖ Rollback completed!"
          EOF
