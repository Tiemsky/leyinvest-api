name: Deploy to LeyInvest Environment (Hostinger)

on:
  push:
    branches: [ develop, feature/* ]
  pull_request:
    branches: [ develop ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: beta

    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, zip

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction

    - name: Create clean deployment archive
      run: |
        echo "ğŸ“¦ Preparing deployment archive..."
        TEMP_DEPLOY_DIR=$(mktemp -d)
        echo "Temporary directory: $TEMP_DEPLOY_DIR"

        # Copy project files excluding CI, tests, docs, node_modules
        rsync -av --exclude='.github' \
                  --exclude='tests' \
                  --exclude='docs' \
                  --exclude='node_modules' \
                  --exclude='deploy-leyinvest.tar.gz' \
                  ./ "$TEMP_DEPLOY_DIR"

        cd "$TEMP_DEPLOY_DIR"
        tar -czf deploy-leyinvest.tar.gz .
        ls -lh deploy-leyinvest.tar.gz
        mv deploy-leyinvest.tar.gz $GITHUB_WORKSPACE/

    - name: Create backup on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 65002
        script: |
          set -e
          BACKUP_DIR="/home/u258421289/leyinvest/backups"
          LEYINVEST_DIR="${{ secrets.REMOTE_PATH_LEYINVEST }}"
          BACKUP_NAME="backup_leyinvest_$(date +%Y%m%d_%H%M%S)"

          mkdir -p "$BACKUP_DIR"

          if [ -d "$LEYINVEST_DIR" ] && [ "$(ls -A $LEYINVEST_DIR)" ]; then
            echo "ğŸ“¦ Creating backup: $BACKUP_NAME"
            tar -czf "$BACKUP_DIR/$BACKUP_NAME.tar.gz" -C "$LEYINVEST_DIR" . 2>/dev/null || true
            echo "$BACKUP_NAME" > /tmp/latest_backup.txt

            cd "$BACKUP_DIR"
            ls -t backup_leyinvest_*.tar.gz | tail -n +6 | xargs -r rm -f
            echo "âœ… Backup created successfully"
          else
            echo "â„¹ï¸ No existing installation to backup"
            echo "none" > /tmp/latest_backup.txt
          fi

    - name: Upload deployment archive
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 65002
        source: "deploy-leyinvest.tar.gz"
        target: "/tmp/"

    - name: Deploy to LeyInvest Server
      id: deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 65002
        script: |
          set -e
          LEYINVEST_DIR="${{ secrets.REMOTE_PATH_LEYINVEST }}"
          echo "ğŸš€ Starting deployment..."
          TEMP_DIR="/tmp/deploy-leyinvest-$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$TEMP_DIR"
          tar -xzf /tmp/deploy-leyinvest.tar.gz -C "$TEMP_DIR"

          # Backup .env and .htaccess if they exist
          [ -f "$LEYINVEST_DIR/.env" ] && cp "$LEYINVEST_DIR/.env" /tmp/backup_env
          [ -f "$LEYINVEST_DIR/public/.htaccess" ] && cp "$LEYINVEST_DIR/public/.htaccess" /tmp/backup_htaccess_public
          [ -f "$LEYINVEST_DIR/.htaccess" ] && cp "$LEYINVEST_DIR/.htaccess" /tmp/backup_htaccess_root

          # Remove old files except storage
          cd "$LEYINVEST_DIR"
          find . -maxdepth 1 ! -name 'storage' ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true

          # Copy new files
          cp -rf "$TEMP_DIR"/* "$LEYINVEST_DIR"/
          cp -rf "$TEMP_DIR"/.[!.]* "$LEYINVEST_DIR"/ 2>/dev/null || true

          # Restore .env
          if [ -f /tmp/backup_env ]; then
            cp /tmp/backup_env "$LEYINVEST_DIR/.env"
            rm /tmp/backup_env
          elif [ -f "$LEYINVEST_DIR/.env.beta" ]; then
            cp "$LEYINVEST_DIR/.env.beta" "$LEYINVEST_DIR/.env"
          elif [ -f "$LEYINVEST_DIR/.env.example" ]; then
            cp "$LEYINVEST_DIR/.env.example" "$LEYINVEST_DIR/.env"
            echo "âš ï¸ Using .env.example"
          fi

          # Restore .htaccess files
          [ -f /tmp/backup_htaccess_public ] && cp /tmp/backup_htaccess_public "$LEYINVEST_DIR/public/.htaccess" && rm /tmp/backup_htaccess_public
          [ -f /tmp/backup_htaccess_root ] && cp /tmp/backup_htaccess_root "$LEYINVEST_DIR/.htaccess" && rm /tmp/backup_htaccess_root

          # Cleanup
          rm -rf "$TEMP_DIR" /tmp/deploy-leyinvest.tar.gz

          echo "âœ… Files deployed successfully"

    - name: Finalize deployment
      id: finalize
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 65002
        script: |
          set -e
          LEYINVEST_DIR="${{ secrets.REMOTE_PATH_LEYINVEST }}"
          BACKUP_DIR="/home/u258421289/leyinvest/backups"
          cd "$LEYINVEST_DIR"

          mkdir -p storage/framework/{cache/data,sessions,views,testing}
          mkdir -p storage/logs
          mkdir -p storage/app/public
          mkdir -p bootstrap/cache

          php artisan down --render="errors::503" --retry=60 2>/dev/null || true

          chmod -R 755 storage bootstrap/cache 2>/dev/null || true
          chmod -R 775 storage/logs storage/framework 2>/dev/null || true

          rm -rf bootstrap/cache/*.php 2>/dev/null || true
          find storage/framework/cache -type f -name "*.php" -delete 2>/dev/null || true
          find storage/framework/views -type f -name "*.php" -delete 2>/dev/null || true

          if command -v composer >/dev/null 2>&1; then
            echo "ğŸ“¦ Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction
          else
            echo "âš ï¸ Composer not found, skipping..."
          fi

          if command -v php >/dev/null 2>&1; then
            echo "ğŸ”„ Running migrations..."
            if php artisan migrate --force --no-interaction 2>&1; then
              echo "âœ… Migrations successful"
              php artisan config:cache
              php artisan route:cache || echo "âš ï¸ Route cache skipped"
              php artisan view:cache
              php artisan optimize:clear
              MIGRATION_SUCCESS=true
            else
              echo "âŒ Migration failed - rollback"
              MIGRATION_SUCCESS=false
            fi
          else
            MIGRATION_SUCCESS=true
          fi

          if [ "$MIGRATION_SUCCESS" = false ]; then
            LATEST_BACKUP=$(cat /tmp/latest_backup.txt 2>/dev/null || echo "none")
            if [ "$LATEST_BACKUP" != "none" ] && [ -f "$BACKUP_DIR/$LATEST_BACKUP.tar.gz" ]; then
              echo "ğŸ”™ Rolling back to: $LATEST_BACKUP"
              cd "$LEYINVEST_DIR"
              find . -maxdepth 1 ! -name '.' ! -name '..' -exec rm -rf {} +
              tar -xzf "$BACKUP_DIR/$LATEST_BACKUP.tar.gz" -C "$LEYINVEST_DIR"
              echo "ROLLBACK=true" > /tmp/deployment_status.txt
              echo "BACKUP_NAME=$LATEST_BACKUP" >> /tmp/deployment_status.txt
            else
              echo "âš ï¸ No backup found - rollback not possible"
              echo "ROLLBACK=failed" > /tmp/deployment_status.txt
            fi
            exit 1
          fi

          php artisan up 2>/dev/null || true
          echo "ROLLBACK=false" > /tmp/deployment_status.txt

    - name: Check deployment status
      id: check_status
      if: always()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 65002
        script: |
          if [ -f /tmp/deployment_status.txt ]; then
            cat /tmp/deployment_status.txt
          else
            echo "ROLLBACK=false"
          fi
      continue-on-error: true

    - name: Send success notification
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.hostinger.com
        server_port: 465
        secure: true
        username: eservice@efournisseurskygroups.ci
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âœ… DÃ©ploiement LeyInvest rÃ©ussi"
        to: tiafranck31@yahoo.fr
        from: eservice@efournisseurskygroups.ci
        body: |
          Bonjour Franck,
          Le dÃ©ploiement sur l'environnement Beta a Ã©tÃ© effectuÃ© avec succÃ¨s.
          ğŸ“¦ Projet : ${{ github.repository }}
          ğŸ”– Branche : ${{ github.ref_name }}
          ğŸ“ Commit : ${{ github.sha }}
          ğŸ‘¤ Auteur : ${{ github.actor }}
          ğŸ• Date : ${{ github.event.head_commit.timestamp }}
          ğŸ“„ Message : ${{ github.event.head_commit.message }}
          ğŸ”— URL Beta : https://leyinvest.skygroups.ci
          Cordialement,
          SystÃ¨me de dÃ©ploiement automatique

    - name: Send rollback notification
      if: failure() && contains(steps.check_status.outputs.stdout, 'ROLLBACK=true')
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.hostinger.com
        server_port: 465
        secure: true
        username: eservice@efournisseurskygroups.ci
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš¨ Rollback dÃ©clenchÃ© - DÃ©ploiement Beta Ã©chouÃ©"
        to: tiafranck31@yahoo.fr
        from: eservice@efournisseurskygroups.ci
        body: |
          Bonjour Franck,
          âš ï¸ Le dÃ©ploiement LeyInvest sur Hostinger a Ã©chouÃ©. Un rollback automatique a Ã©tÃ© effectuÃ©.
          ğŸ“¦ Projet : ${{ github.repository }}
          ğŸ”– Branche : ${{ github.ref_name }}
          ğŸ“ Commit : ${{ github.sha }}
          ğŸ‘¤ Auteur : ${{ github.actor }}
          ğŸ” VÃ©rifiez les logs GitHub Actions : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Cordialement,
          SystÃ¨me de dÃ©ploiement automatique

    - name: Send failure notification
      if: failure() && !contains(steps.check_status.outputs.stdout, 'ROLLBACK=true')
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.hostinger.com
        server_port: 465
        secure: true
        username: eservice@efournisseurskygroups.ci
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âŒ DÃ©ploiement Leyinvest Ã©chouÃ©"
        to: tiafranck31@yahoo.fr
        from: eservice@efournisseurskygroups.ci
        body: |
          Bonjour Franck,
          âŒ Le dÃ©ploiement Beta sur Hostinger a Ã©chouÃ©.
          ğŸ“¦ Projet : ${{ github.repository }}
          ğŸ”– Branche : ${{ github.ref_name }}
          ğŸ“ Commit : ${{ github.sha }}
          ğŸ‘¤ Auteur : ${{ github.actor }}
          ğŸ” VÃ©rifiez les logs GitHub Actions : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Cordialement,
          SystÃ¨me de dÃ©ploiement automatique
