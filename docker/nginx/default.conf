# Le proxy interne écoute sur le port 80 (qui est mappé au 8001 de l'hôte)
server {
    listen 80;
    listen [::]:80;
    server_name _; # Peut être n'importe quoi, le routage est basé sur les headers de Dokploy

    # Dokploy gère le SSL/TLS et les headers X-Forwarded-*
    # Nous n'avons besoin que de router vers les services internes.

    # --- 1. API LARAVEL (Accessible via /laravel/) ---
    location /laravel/ {
        fastcgi_pass laravel_app:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
    }

    # 2. API FASTAPI (Accessible via /fastapi/)
    location /fastapi/ {
        proxy_pass http://fastapi_app:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- 3. INTERFACES DE DÉBOGAGE (Même configuration que les API) ---

    # PGADMIN (PostgreSQL)
    location /pgadmin/ {
        proxy_pass http://pgadmin:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_redirect off;
    }

    # PHPMYADMIN (MySQL)
    location /phpmyadmin/ {
        proxy_pass http://phpmyadmin:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_redirect off;
    }

    # Root par défaut : pour les assets statiques Laravel
    location / {
        root /var/www/public;
        try_files $uri /index.php$is_args$args;
    }
}
