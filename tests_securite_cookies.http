### ============================================
### TESTS DE S√âCURIT√â - HTTP-ONLY COOKIES
### ============================================
### Utilisez l'extension REST Client VS Code ou HTTPie
### ============================================

@baseUrl = http://localhost:8000/api/v1
@email = test@example.com
@password = password123

### ============================================
### 1Ô∏è‚É£ TEST LOGIN - V√©rifier le Cookie HTTP-Only
### ============================================
# @name login
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}

### ‚úÖ V√©rifications attendues :
### - Status: 200 OK
### - Response contient : access_token, user, token_type, expires_in
### - Response NE CONTIENT PAS : refresh_token (dans JSON)
### - Header Set-Cookie contient : refresh_token=...; HttpOnly; Path=/; SameSite=strict

### Extraire l'access_token de la r√©ponse
@accessToken = {{login.response.body.$.data.access_token}}

### ============================================
### 2Ô∏è‚É£ TEST ACC√àS PROT√âG√â - Avec Access Token
### ============================================
GET {{baseUrl}}/auth/user/me
Authorization: Bearer {{accessToken}}
Content-Type: application/json

### ‚úÖ V√©rifications attendues :
### - Status: 200 OK
### - Response contient les informations de l'utilisateur

### ============================================
### 3Ô∏è‚É£ TEST REFRESH TOKEN - Lecture depuis Cookie
### ============================================
# @name refresh
POST {{baseUrl}}/auth/refresh-token
Content-Type: application/json
# Note: Le cookie refresh_token est envoy√© automatiquement par le client HTTP

### ‚úÖ V√©rifications attendues :
### - Status: 200 OK
### - Response contient : nouveau access_token
### - Response NE CONTIENT PAS : refresh_token (dans JSON)
### - Header Set-Cookie contient : nouveau refresh_token

### Extraire le nouvel access_token
@newAccessToken = {{refresh.response.body.$.data.access_token}}

### ============================================
### 4Ô∏è‚É£ TEST ACC√àS AVEC NOUVEAU TOKEN
### ============================================
GET {{baseUrl}}/auth/user/me
Authorization: Bearer {{newAccessToken}}
Content-Type: application/json

### ‚úÖ V√©rifications attendues :
### - Status: 200 OK
### - Fonctionne avec le nouveau token

### ============================================
### 5Ô∏è‚É£ TEST LOGOUT - Invalidation du Cookie
### ============================================
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{newAccessToken}}
Content-Type: application/json

### ‚úÖ V√©rifications attendues :
### - Status: 200 OK
### - Header Set-Cookie contient : refresh_token=; Expires=... (cookie expir√©)

### ============================================
### 6Ô∏è‚É£ TEST REFRESH APR√àS LOGOUT (Doit √©chouer)
### ============================================
POST {{baseUrl}}/auth/refresh-token
Content-Type: application/json

### ‚ùå V√©rifications attendues :
### - Status: 401 Unauthorized ou 422 Validation Error
### - Message d'erreur : Token invalide ou manquant

### ============================================
### 7Ô∏è‚É£ TEST RATE LIMITING - Login (5 tentatives max)
### ============================================
# Tentative 1
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "wrong@example.com",
  "password": "wrongpassword"
}

###
# Tentative 2
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "wrong@example.com",
  "password": "wrongpassword"
}

###
# Tentative 3
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "wrong@example.com",
  "password": "wrongpassword"
}

###
# Tentative 4
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "wrong@example.com",
  "password": "wrongpassword"
}

###
# Tentative 5
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "wrong@example.com",
  "password": "wrongpassword"
}

###
# Tentative 6 (Doit √™tre bloqu√©e)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "wrong@example.com",
  "password": "wrongpassword"
}

### ‚ùå V√©rifications attendues :
### - Status: 429 Too Many Requests
### - Header: Retry-After: 60

### ============================================
### 8Ô∏è‚É£ TEST COMPATIBILIT√â - Refresh via JSON Body (D√©pr√©ci√©)
### ============================================
# @name loginCompat
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}

### Simuler l'ancien comportement (refresh_token dans le body)
# Note: Cette m√©thode est d√©pr√©ci√©e et g√©n√®re un warning
POST {{baseUrl}}/auth/refresh-token
Content-Type: application/json

{
  "refresh_token": "token_factice_pour_test"
}

### ‚ö†Ô∏è V√©rifications attendues :
### - Fonctionne temporairement (compatibilit√©)
### - Warning dans les logs Laravel : "Refresh token re√ßu via JSON body (d√©pr√©ci√©)"

### ============================================
### 9Ô∏è‚É£ TEST CORS - Preflight Request
### ============================================
OPTIONS {{baseUrl}}/auth/login
Origin: http://localhost:3000
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Content-Type

### ‚úÖ V√©rifications attendues :
### - Status: 200 OK ou 204 No Content
### - Header Access-Control-Allow-Origin: http://localhost:3000
### - Header Access-Control-Allow-Credentials: true
### - Header Access-Control-Allow-Methods: POST, ...

### ============================================
### üîü TEST S√âCURIT√â - Cookie Attributes
### ============================================
# @name securityTest
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}

### ‚úÖ V√©rifier dans le header Set-Cookie :
### - HttpOnly (pr√©sent)
### - SameSite=strict (pr√©sent)
### - Secure (pr√©sent si APP_ENV=production)
### - Path=/ (pr√©sent)
### - Max-Age ou Expires (pr√©sent, ~7 jours)

### ============================================
### NOTES DE TEST
### ============================================
#
# üîπ Utilisation avec curl :
#
# Login avec sauvegarde du cookie :
# curl -X POST http://localhost:8000/api/v1/auth/login \
#   -H "Content-Type: application/json" \
#   -d '{"email":"test@example.com","password":"password123"}' \
#   -c cookies.txt -v
#
# Refresh avec envoi du cookie :
# curl -X POST http://localhost:8000/api/v1/auth/refresh-token \
#   -H "Content-Type: application/json" \
#   -b cookies.txt -c cookies.txt -v
#
# Logout avec invalidation :
# curl -X POST http://localhost:8000/api/v1/auth/logout \
#   -H "Authorization: Bearer {access_token}" \
#   -b cookies.txt -v
#
# üîπ Utilisation avec HTTPie :
#
# Login :
# http POST http://localhost:8000/api/v1/auth/login \
#   email=test@example.com password=password123 \
#   --session=./session.json
#
# Refresh :
# http POST http://localhost:8000/api/v1/auth/refresh-token \
#   --session=./session.json
#
### ============================================
